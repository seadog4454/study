GAS LISTING boot.s 			page 1


   1              	.code16
   2              	.text
   3              	.global _start
   4              	
   5              	
   6              	
   7              	_start:
   8 0000 EB00     	  jmp ipl
   9              	
  10              	  # BPB
  11              	  
  12              	  #.org 90 - (. - _start), 0x90
  13              	
  14              	  # IPL
  15              	 ipl:
  16              	  /*
  17              	  cli
  18              	  mov $0x0000, %ax
  19              	  mov %ax, %ds
  20              	  mov %ax, %es
  21              	  mov %ax, %ss
  22              	  # mov (BOOT_LOAD), %sp
  23              	  mov $0x7C00, %sp
  24              	  sti
  25              	  mov %dl, (boot_drive)
  26              	  */
  27              	
  28              	  # push $0x41
  29              	  # call putc
  30              	  # add $2, %sp
  31              	  
  32              	  /*
  33              	  push $s0
  34              	  call puts
  35              	  add $2, %sp
  36              	  */
  37              	  /*
  38              	  push $0b0000
  39              	  push $10
  40              	  push $8
  41              	  push $s1
  42              	  pushw $15
  43              	  call itoa
  44              	
  45              	  push $s1
  46              	  call puts  
  47              	  */
  48              	  
  49              	# read 512 bytes : read sector
  50 0002 B402     	  mov $0x02, %ah # instruct read
  51 0004 B001     	  mov $0x1, %al # number of reading sector
  52 0006 B90200   	  mov $0x0002, %cx # cylinder/sector
  53 0009 B600     	  mov $0x00, %dh # head position
  54              	  # mov (boot_drive), %dl # drive number
  55 000b B280     	  mov $0x80, %dl
  56 000d BB007E   	  mov $0x7E00, %bx # offset
  57 0010 CD13     	  int $0x13 # bios call : read sector
GAS LISTING boot.s 			page 2


  58 0012 730C     	  jnc .Lboot1
  59 0014 680000   	  push $e0
  60 0017 E83500   	  call puts
  61 001a 83C402   	  add $0x2, %sp
  62 001d E84E00   	  call reboot
  63              	.Lboot1:
  64 0020 E98A00   	  jmp stage_2
  65              	
  66              	
  67              	
  68 0023 426F6F74 	s0: .string "Booting...\r\n"
  68      696E672E 
  68      2E2E0D0A 
  68      00
  69 0030 2D2D2D2D 	;s1: .string "--------\r\n"
  69      2D2D2D2D 
  69      0D0A00
  70 003b 4572726F 	e0: .string "Error:sector read"
  70      723A7365 
  70      63746F72 
  70      20726561 
  70      6400
  71 004d 007C     	BOOT_LOAD: .word 0x7C00
  72              	
  73              	#.align 2
  74              	# BOOT:
  75              	# drive: .byte 0xBB
  76              	#boot_drive: .word 0x0000
  77              	
  78              	#.include "../modules/real/putc.s"
  79              	.include "../modules/real/puts.s"
   1              	.code16
   2              	
   3              	puts:
   4 004f 55       	  push %bp
   5 0050 89E5     	  mov %sp, %bp
   6              	
   7 0052 50       	  push %ax
   8 0053 53       	  push %bx
   9 0054 56       	  push %si #arg1: pointer of strings
  10              	
  11 0055 8B7604   	  mov 0x4(%bp), %si
  12              	
  13 0058 B40E     	  mov $0x0E, %ah # output one char
  14 005a BB0000   	  mov $0x0000, %bx
  15 005d FC       	  cld # DF = 0
  16              	
  17              	  
  18              	/*
  19              	for(i=0, AL != null; AL++){
  20              	  int 0x10 # put AL
  21              	}
  22              	*/
  23              	
  24              	
  25              	.loop1:
  26 005e AC       	  lodsb # AL = *SI++
GAS LISTING boot.s 			page 3


  27 005f 3C00     	  cmp $0, %al
  28 0061 7404     	  je .L1
  29              	  
  30 0063 CD10     	  int $0x10
  31 0065 EBF7     	  jmp .loop1
  32              	
  33              	.L1:
  34              	
  35 0067 5E       	  pop %si
  36 0068 5B       	  pop %bx
  37 0069 58       	  pop %ax
  38              	
  39 006a 89EC     	  mov %bp, %sp
  40 006c 5D       	  pop %bp
  41              	
  42 006d C3       	  ret
  43              	 
  80              	#.include "../modules/real/itoa.s"
  81              	.include "../modules/real/reboot.s"
   1              	reboot:
   2 006e 680000   		push $s_reboot_signal
   3 0071 E8DBFF   		call puts
   4 0074 83C402   		add $0x2, %sp
   5              	
   6              	.Lreboot1:
   7 0077 B410     		mov $0x10, %ah # wait input key
   8 0079 CD16     		int $0x16 # bios call: input key
   9              	
  10 007b 3C20     		cmp $0x20, %al
  11 007d 75F8     		jne .Lreboot1
  12              	
  13              		
  14 007f 680000   		push $s_reboot_newline
  15 0082 E8CAFF   		call puts
  16 0085 83C402   		add $0x2, %sp
  17              	
  18 0088 CD19     		int $0x19 # bios call: reboot
  19              	
  20              	
  21 008a 50757368 	s_reboot_signal: .string "Push SPACE key to reboot...\r\n"
  21      20535041 
  21      4345206B 
  21      65792074 
  21      6F207265 
  22 00a8 0D0A0D0A 	s_reboot_newline: .string "\r\n\r\n"
  22      00
  23              	
  24              	
  82              	
  83              	
  84              	stage_2:
  85 00ad 680000   	  push $s2
  86 00b0 E89CFF   	  call puts
  87 00b3 83C402   	  add $0x2, %sp
  88 00b6 EBFE     	  jmp .
  89              	
  90 00b8 326E6420 	s2: .string "2nd stage...\r\n"
GAS LISTING boot.s 			page 4


  90      73746167 
  90      652E2E2E 
  90      0D0A00
  91              	
GAS LISTING boot.s 			page 5


DEFINED SYMBOLS
              boot.s:7      .text:0000000000000000 _start
              boot.s:15     .text:0000000000000002 ipl
              boot.s:70     .text:000000000000003b e0
../modules/real/puts.s:3      .text:000000000000004f puts
../modules/real/reboot.s:1      .text:000000000000006e reboot
              boot.s:84     .text:00000000000000ad stage_2
              boot.s:68     .text:0000000000000023 s0
              boot.s:69     .text:0000000000000030 s1
              boot.s:71     .text:000000000000004d BOOT_LOAD
../modules/real/puts.s:25     .text:000000000000005e .loop1
../modules/real/reboot.s:21     .text:000000000000008a s_reboot_signal
../modules/real/reboot.s:22     .text:00000000000000a8 s_reboot_newline
              boot.s:90     .text:00000000000000b8 s2

NO UNDEFINED SYMBOLS
